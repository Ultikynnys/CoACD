name: Build Wheels
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build_wheels:
    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.os }} - ${{ matrix.arch }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        arch: [ x86_64 ]
        include:
          - os: ubuntu-24.04-arm
            arch: aarch64
          - os: macos-latest
            arch: arm64
          - os: windows-2025
            arch: AMD64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Dependencies macOS
        if: runner.os == 'macOS'
        run: pip3 install --break-system-packages wheel

      - name: Install Dependencies (non-macOS)
        if: runner.os != 'macOS'
        run: pip3 install -U wheel

      - name: Build Wheels
        uses: pypa/cibuildwheel@v2.22.0
        env:
          CIBW_ARCHS: 'auto64'
          CIBW_BUILD: >
            cp3{9,10,11,12,13}-macosx_${{ matrix.arch }}
            cp3{9,10,11,12,13}-manylinux_${{ matrix.arch }}
            cp3{9,10,11,12,13}-win_amd64
          MACOSX_DEPLOYMENT_TARGET: "11"
          CIBW_BUILD_VERBOSITY: 1
          # Skip tests during wheel build
          CIBW_TEST_COMMAND: ""
          # Use default repair commands (cibuildwheel handles platform detection automatically)

      - name: List Build Results
        shell: bash
        run: ls -lh wheelhouse

      - name: Verify Wheel Contents
        shell: bash
        run: |
          echo "Verifying wheel contents..."
          for wheel in wheelhouse/*.whl; do
            echo "Inspecting $wheel"
            python -m zipfile -l "$wheel" | grep -E '\.(so|pyd|dll|dylib)' || echo "Warning: No binaries found in $wheel"
          done

      - name: Test Wheel Functionality
        shell: bash
        run: |
          echo "Testing wheel functionality with example mesh..."
          # Install the built wheel (use the first matching wheel for this platform)
          WHEEL=$(ls wheelhouse/*.whl | head -1)
          echo "Installing wheel: $WHEEL"
          python -m pip install "$WHEEL" numpy trimesh
          
          # Run a quick CoACD test
          python -c "
          import trimesh
          import coacd_u as coacd
          
          print('Testing CoACD on Bottle.obj...')
          coacd.set_log_level('info')
          mesh = trimesh.load('examples/Bottle.obj', force='mesh')
          coacd_mesh = coacd.Mesh(mesh.vertices, mesh.faces)
          result = coacd.run_coacd(coacd_mesh, threshold=0.05)
          print(f'SUCCESS: Generated {len(result)} convex hulls')
          assert len(result) > 0, 'Expected at least one convex hull'
          print('Test passed!')
          "

      - name: Upload Wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.arch }}
          path: ./wheelhouse/*.whl
          if-no-files-found: warn
          compression-level: 6
          overwrite: false
