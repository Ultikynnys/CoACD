name: Build Wheels
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build_wheels:
    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.os }} - ${{ matrix.arch }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, ubuntu-22.04, macos-13 ]
        arch: [ x86_64 ]
        include:
          - os: ubuntu-24.04-arm
            arch: aarch64
          - os: ubuntu-22.04-arm
            arch: aarch64
          - os: macos-latest
            arch: arm64
          - os: windows-2025
            arch: AMD64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Dependencies macOS
        if: runner.os == 'macOS'
        run: pip3 install --break-system-packages wheel

      - name: Install Dependencies (non-macOS)
        if: runner.os != 'macOS'
        run: pip3 install -U wheel

      - name: Build Wheels
        uses: pypa/cibuildwheel@v2.22.0
        env:
          CIBW_ARCHS: 'auto64'
          CIBW_BUILD: >
            cp3{9,10,11,12,13}-macosx_${{ matrix.arch }}
            cp3{9,10,11,12,13}-manylinux_${{ matrix.arch }}
            cp3{9,10,11,12,13}-win_amd64
          MACOSX_DEPLOYMENT_TARGET: "11"
          CIBW_BUILD_VERBOSITY: 1
          # Skip tests during wheel build
          CIBW_TEST_COMMAND: ""
          # Ensure binaries are repaired/bundled properly (these are defaults but being explicit)
          # Linux: auditwheel bundles external .so dependencies
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: "auditwheel repair --plat {platform_tag} -w {dest_dir} {wheel}"
          # macOS: delocate bundles external .dylib dependencies  
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: "delocate-wheel --require-archs {delocate_archs} -w {dest_dir} -v {wheel}"
          # Windows: delvewheel bundles external .dll dependencies
          CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: "delvewheel repair --add-path /c/Program\ Files/CMake/bin -w {dest_dir} {wheel}"

      - name: List Build Results
        run: ls -lh wheelhouse

      - name: Verify Wheel Contents
        shell: bash
        run: |
          echo "Verifying wheel contents..."
          for wheel in wheelhouse/*.whl; do
            echo "Inspecting $wheel"
            python -m zipfile -l "$wheel" | grep -E '\.(so|pyd|dll|dylib)' || echo "Warning: No binaries found in $wheel"
          done

      - name: Upload Wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.arch }}
          path: ./wheelhouse/*.whl
          if-no-files-found: warn
          compression-level: 6
          overwrite: false
